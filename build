#!/usr/bin/python

import os, json

tfname = "template.html"
embed_mark = "<!--markdown-->"

# get template
def extract_template(path):
    f = open(path)
    s = f.read()
    f.close()
    a = s.find(embed_mark)
    b = a + len(embed_mark)
    return s[:a], s[b:]

def process_file(fpath, head, tail):
    input_name = fpath
    output_name = input_name[:-3] + ".html" # remove .md ending
    f = open(output_name, "w")
    f.write(head)
    f.close()
    os.system("md2html '{}' >> '{}'".format(input_name, output_name))
    f = open(output_name, "a")
    f.write(tail)
    f.close()

def walk(path):
    for dpath, dnames, fnames in os.walk(path):
        if tfname in fnames:
            ls = []
            head, tail = extract_template(dpath + "/" + tfname)
            for fn in fnames:
                if fn.endswith(".md"):
                    fpath = "{}/{}".format(dpath, fn)
                    opath = 
                    process_file(fpath, head, tail)
                    ls.append(os.path.getmtime(html")
            if len(ls) > 0:
                dump_list(dpath, ls)
            for dir in dnames:
                walk("{}/{}".format(dpath, dir))

def dump_list(path, ls):
    # dump articles
    lfile = open("{}/list.json".format(path), "w")
    lfile.write(json.dumps(ls))
    lfile.write("\n")
    lfile.close()

walk(os.curdir)
