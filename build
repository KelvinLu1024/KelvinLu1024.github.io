#!/usr/bin/python

import os, json

tfname = "template.html"
embed_mark = "<!--markdown-->"

# get template
def extract_template(path):
    f = open(path)
    s = f.read()
    f.close()
    a = s.find(embed_mark)
    b = a + len(embed_mark)
    return s[:a], s[b:]

def process_file(input_name, output_name, head, tail):
    f = open(output_name, "w")
    f.write(head)
    f.close()
    os.system("md2html '{}' >> '{}'".format(input_name, output_name))
    f = open(output_name, "a")
    f.write(tail)
    f.close()

def walk(path):
    for dpath, dnames, fnames in os.walk(path):
        if tfname in fnames:
            ls = []
            tfpath = "{}/{}".format(dpath, tfname)
            (head, tail) = extract_template(tfpath)
            for fn in fnames:
                if fn.endswith(".md"):
                    ifpath = "{}/{}".format(dpath, fn)
                    ofpath = ifpath[:-3] + ".html"
                    process_file(ifpath, ofpath, head, tail)
                    ls.append(ofpath)
            if len(ls) > 0:
                def fcmp(fp1, fp2):
                    return
                ls.sort(lambda fp1, fp2: cmp(os.path.getmtime(fp1), os.path.getmtime(fp2)))
                dump_list(dpath, ls)
            for dir in dnames:
                walk("{}/{}".format(dpath, dir))

def dump_list(path, ls):
    # dump articles
    lfile = open("{}/list.json".format(path), "w")
    lfile.write(json.dumps(ls))
    lfile.write("\n")
    lfile.close()

walk(os.curdir)
